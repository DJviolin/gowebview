<!DOCTYPE html>
<html lang="en">
<head>
    <title>GoTodoApp</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/res/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <script src="/res/jquery/jquery.min.js" ></script>
    <script src="/res/react/react.js"></script>
    <script src="/res/react/JSXTransformer.js"></script>
    <script src="/res/bootstrap/js/bootstrap.min.js" ></script>
    <style media="screen" type="text/css">
        .bluepanel{
        	background-color: #A9F5F2;
        }
        .redpanel{
        	background-color: #ff9999;
        }
        .todoicon{
        	color:#808080;
        	font-size: 20px;
        }
        .greypanel{
            background-color: #EEEEEE;
        }
        #todolist{
            padding-top:15px;
        }
        .glyphicon{
            padding-left: 5px;
            font-size: larger;
        }
    </style>
</head>
<body>
	<div class="container-fluid" >
		<div class="row" >
			<div class="col-md-12" id="todolist"></div>
		</div>
	</div>

    <script type="text/jsx">


        var TodoNew = React.createClass({
            getInitialState: function() {
                return {priority: 0};
            },
            render:function(){
                var thiscolor;
                if(this.state.priority == 0){
                    thiscolor = "#808080"
                }else{
                    thiscolor = "#FF8080"
                }
                return(
                    <div className="panel greypanel">
            	    	<div className="panel-body " id="createItemPanel">
                    		<table width="100%">
                    			<tr>
                                    <td><input type="text" className="form-control" id="createItemText" placeholder="Create a Todo" /></td>
        				            <td width="10%">&nbsp;<span onClick={this.handleClickPriority} className="glyphicon glyphicon-exclamation-sign todoicon" style={{"color":thiscolor}}></span></td>
        				            <td width="10%"><span onClick={this.handleClickCreate} className="glyphicon glyphicon-plus todoicon"></span></td>
            	        		</tr>
                    		</table>
            	    	</div>
                    </div>
                );
            },
            handleClickCreate:function(evt){
                var txt = $(React.findDOMNode(this)).find("#createItemText").val();
                if(txt == ""){
                    return;
                }
                var impt = this.state.priority;
                createItem(txt, impt);
                $(React.findDOMNode(this)).find("#createItemText").val("");
                this.setState({priority:0});
            },
            handleClickPriority:function(evt){
                if(this.state.priority ==0){
                    this.setState({priority:1});
                } else{
                    this.setState({priority:0});
                }
            }
        });

        var Todo = React.createClass({
        	render:function(){
        		var colorclass;
        		switch(this.props.item.Priority){
        		case 1:
        			colorclass = "panel redpanel"
        			break;
        		default:
        			colorclass = "panel bluepanel"
        			break;
        		}

        		return(
        			<div className={colorclass}>
        	    	    <div className="panel-body ">
                				<table width="100%">
                					<tr>
        	        					<td>{this.props.item.Text}</td>
        	        					<td width="10%"><span onClick={this.handleClick} className="glyphicon glyphicon-thumbs-up todoicon"></span></td>
        	        				</tr>
                				</table>
        	    	    </div>
        		    </div>
        		);
        	},
        	handleClick:function(evt){
                deleteItem(this.props.item.ID);
            }
        });


        var TodoList = React.createClass({
        	render:function(){
        		var self = this;
        		var todos = this.props.items.map(function(item){
        			return(
        				<Todo key = {item.ID} item={item}/>
        			)
        		});

        		return(
        			<div>
                        <TodoNew />
        				{todos}
        			</div>
        		);
        	},
            componentDidMount:function(){
                fetchItems();
            }
        });

        var deleteItem = function(itemid){
        	$.ajax({
        		url:"/items/"+itemid,
        		type:"GET",
        		success:function(){
                    fetchItems();
                },
        		error:function(xhr, status, errorThrown){
        			alert("Error deleting items - "+ errorThrown)
        		}

        	});
        };

        var createItem=function(txt, priority){
            var item = {"ID":"newitem","Text":txt,"Priority":priority}
        	$.ajax({
        		url: '/items/new',
        		type: 'POST',
        		data: {data: JSON.stringify(item)},
        		success:function(ret){
        			fetchItems();
        		},
        		error:function(xhr, status, errorThrown){
        			alert("Error creating todo item")
        		}
        	});
        }

        var fetchItems = function(){
        	$.ajax({
        		url:"/items",
        		type:"GET",
        		datatype:"json",
        		success:function(json){
        			var items = $.parseJSON(json);
        			React.render(
        				<TodoList items={items} />,
        				document.getElementById("todolist")
        			);
        		},
        		error:function(xhr, status, errorThrown){
        			alert("Error fetching items - "+ errorThrown)
        		}

        	});
        }

        // Shorthand for $( document ).ready()
        $(function() {
            fetchItems();
        });


    </script>
</body>
</html>
